version: '3.8'

services:
  # --- INFRASTRUCTURE ---

  # 1. MySQL (For User Service)
  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: fitness_user_db
    ports:
      - "3306:3306"
    networks:
      - spring-net

  # 2. MongoDB (For Activity & AI Service)
  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "27017:27017"
    networks:
      - spring-net

  # 3. RabbitMQ (For Messaging)
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"   # App Port
      - "15672:15672" # Dashboard Port (User: guest, Pass: guest)
    networks:
      - spring-net

  # 4. Keycloak (Authentication)
  keycloak:
    image: quay.io/keycloak/keycloak:22.0.1
    container_name: keycloak
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8181:8080" # Maps localhost:8181 to container:8080
    networks:
      - spring-net

  # --- JAVA SERVICES ---

  # 5. Config Server
  config-server:
    build: ./config-server
    container_name: config-server
    ports:
      - "8888:8888"
    networks:
      - spring-net
    healthcheck:
      # This command tries to open a URL. If it fails, the server is "Unhealthy"
      test: "wget --no-verbose --tries=1 --spider http://localhost:8888/activity-service/default || exit 1"
      interval: 10s     # Check every 10 seconds
      retries: 5        # Fail after 5 tries (50s total)
      start_period: 10s # Give it 10s to boot before starting checks
      timeout: 5s

  # 6. Discovery Server (Eureka)
  discovery-server:
    build: ./discovery-server
    container_name: discovery-server
    ports:
      - "8761:8761"
    environment:
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888/
    depends_on:
      - config-server
    networks:
      - spring-net

  # 7. User Service
  user-service:
    build: ./user-service
    container_name: user-service
    restart: on-failure
    ports:
      - "8081:8081"
    environment:
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888/
      - FRONTEND_URL=${FRONTEND_URL}
    depends_on:
      discovery-server:
        condition: service_started
      mysql:
        condition: service_started
      # This is the MAGIC part. It waits for the "wget" check to pass.
      config-server:
        condition: service_healthy
    networks:
      - spring-net

  # 8. Activity Service
  activity-service:
    build: ./activity-service
    container_name: activity-service
    restart: on-failure
    ports:
      - "8082:8082"
    environment:
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888/
    depends_on:
      discovery-server:
        condition: service_started
      mongodb:
        condition: service_started
      rabbitmq:
        condition: service_started
      config-server:
        condition: service_healthy
    networks:
      - spring-net

  # 9. AI Service
  ai-service:
    build: ./ai-service
    container_name: ai-service
    restart: on-failure
    ports:
      - "8083:8083"
    environment:
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888/
      # Replace this with your actual key or use a .env file
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_API_URL=${GEMINI_API_URL}
    depends_on:
      discovery-server:
        condition: service_started
      mongodb:
        condition: service_started
      rabbitmq:
        condition: service_started
      config-server:
        condition: service_healthy
    networks:
      - spring-net

  # 10. API Gateway
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    restart: on-failure
    ports:
      - "8080:8080"
    environment:
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888/
      - FRONTEND_URL=${FRONTEND_URL}
    depends_on:
      discovery-server:
        condition: service_started
      keycloak:
        condition: service_started
      user-service:
        condition: service_started
      config-server:
        condition: service_healthy
    networks:
      - spring-net

networks:
  spring-net:
    driver: bridge